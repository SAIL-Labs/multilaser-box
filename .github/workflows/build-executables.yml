name: Build Standalone Executables

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: 'dev'

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          activate-environment: multilaser
          environment-file: environment.yml
          python-version: '3.11'

      - name: Build Windows executable
        run: |
          pyinstaller --onefile --windowed --name=MultiLaserController --icon=figures/icon.ico --add-data="figures/icon.ico;figures" --hidden-import=pyvisa --hidden-import=pyvisa_py multilaser/laser_controller_gui.py

      - name: Package Windows artifacts
        run: |
          mkdir -p release/windows
          copy dist\MultiLaserController.exe release\windows\
          copy README.md release\windows\
          copy multilaser_manual.md release\windows\
          xcopy /E /I laser_ttl_controller release\windows\laser_ttl_controller

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MultiLaserController-Windows
          path: release/windows/

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: MultiLaserController-Windows
          path: windows-release/

      - name: Create release archives
        run: |
          cd windows-release && zip -r ../MultiLaserController-Windows.zip . && cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MultiLaserController-Windows.zip
          body: |
            ## Multi-Laser Controller Release

            Standalone executable for Windows.

            ### Windows Installation
            1. Download `MultiLaserController-Windows.zip`
            2. Extract the archive
            3. Run `MultiLaserController.exe`

            ### Arduino Firmware
            The `laser_ttl_controller` folder contains the Arduino firmware files.
            Upload the appropriate `.ino` file to your Arduino board.

            See `README.md` and `multilaser_manual.md` for detailed usage instructions.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
